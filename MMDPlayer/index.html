<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <script type="text/javascript" src="./Scripts/three.js"></script>
    <script type="text/javascript" src="./Scripts/MMDToonShader.js"></script>
    <script type="text/javascript" src="./Scripts/mmdparser.js"></script>
    <script type="text/javascript" src="./Scripts/TGALoader.js"></script>
    <script type="text/javascript" src="./Scripts/OutlineEffect.js"></script>
    <script type="text/javascript" src="./Scripts/MMDLoader.js"></script>
    <!-- GitHub https://github.com/kripken/ammo.js/tree/main/builds よりダウンロード -->
    <script type="text/javascript" src="./Scripts/ammo.js"></script>
    <!-- ./examples/js/animation/CCDIKSolver.js (r131) -->
    <script type="text/javascript" src="./Scripts/CCDIKSolver.js"></script>
    <!-- ./examples/js/animation/MMDPhysics.js (r131) -->
    <script type="text/javascript" src="./Scripts/MMDPhysics.js"></script>
    <!-- ./examples/js/animation/MMDAnimationHelper.js (r131) -->
    <script type="text/javascript" src="./Scripts/MMDAnimationHelper.js"></script>
    <script type="text/javascript" src="./Scripts/OrbitControls.js"></script>
    <title>MMD Player</title>
  </head>
  <body>
    <!-- MMDが描画されるHTML要素 -->
    <div id="webgl" style="width: auto; height: 95vh;"></div>
      <!-- モーションの開始/一時停止ボタン -->
    <button type="button" id="start">スタート</button>
    <script>
  //***********************************************************************************************
  // 変数設定
  //***********************************************************************************************
      let camera = {};
      let controls = {};
      let effect = {};
      let light = {};
      let mesh = {};
      let renderer = {};
      let scene = {};
      let canvasSizeW = parseInt( window.getComputedStyle( document.getElementById( 'webgl' ) ).width );
      let canvasSizeH = parseInt( window.getComputedStyle( document.getElementById( 'webgl' ) ).height );
      
      let vector3 = new THREE.Vector3();
      
      // MMD 3Dモデルのモーションに関連する変数
      const ANIMATION_HELPER = new THREE.MMDAnimationHelper();
      const CLOCK = new THREE.Clock();
      let animationMixer = {};
      let motions = [] ;
      // モーションのインデックス、-1の時はモーションは適用されていないことを示す
      let motionIndex = -1;
      // 読み込むMMD 3Dモデルのファイル(PMXファイル)をオブジェクトで管理する
      const PMX_FILE = { name: 'ニコニ立体ちゃん', file: './Model/Alicia_solid.pmx', emissive: 0.3, multiply: 0.0739, physics: true, receiveShadow: true, thickness: 0.001 };
      // 読み込むモーションファイル(VMDファイル)をオブジェクトで管理する
      const VMD_FILE = { name: '好き！雪！本気マジック', file: './Music/motion.vmd' };

      let music = new Audio('./Music/music.m4a');
  //***********************************************************************************************
  // メインプログラム
  //***********************************************************************************************
      // DOMの解析が終わったらメインプログラムを実行
      document.addEventListener( 'DOMContentLoaded', function () {
        // Ammo の 「Ammo.btDefaultCollisionConfiguration is not a function」 のエラー回避
        Ammo().then( function ( AmmoLib ) {
          Ammo = AmmoLib;
          // (1) シーンの準備
          prepareScene();
          // (2) MMD 3Dモデルをロードし、シーンに追加
          loadMMD();
          // (3) レンダリング (レンダリングループ)
          sceneRender();
        } );
      }, false );
    //-----------------------------------------------------------------------------------------------
    // (1)シーンの準備
    //-----------------------------------------------------------------------------------------------
      function prepareScene() {
        renderer = new THREE.WebGLRenderer( { antialias: true } );
        renderer.setPixelRatio( window.devicePixelRatio );
        renderer.setSize( canvasSizeW, canvasSizeH );
        renderer.setClearColor( 0xffffff, 1.0 );
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.getElementById( 'webgl' ).appendChild( renderer.domElement );
        effect = new THREE.OutlineEffect( renderer );
        scene = new THREE.Scene();
        scene.add( new THREE.AmbientLight( 0xffffff, 0.6 ) );
        light = new THREE.DirectionalLight( 0xffe2b9, 0.4 );
        light.castShadow = true;
        light.position.copy( new THREE.Vector3( 2, 4.7, 2 ) );
        light.shadow.mapSize.copy( new THREE.Vector2 ( Math.pow( 2, 10 ), Math.pow( 2, 10 ) ) );
        light.shadow.focus = 1;
        light.shadow.normalBias = 0.02;
        light.shadow.bias = -0.0005;
        light.shadow.camera.left = -5;
        light.shadow.camera.right = 5;
        light.shadow.camera.top = 5;
        light.shadow.camera.bottom = -5;
        light.shadow.camera.near = 0.1;
        light.shadow.camera.far = 20;
        scene.add( light );
        scene.add( light.target );

        camera = new THREE.PerspectiveCamera( 22.9, canvasSizeW / canvasSizeH, 0.1, 20 );
        camera.position.set(0, 3, 8);
        controls = new THREE.OrbitControls( camera, renderer.domElement );

        const GROUND_MESH = new THREE.Mesh( new THREE.PlaneGeometry( 10, 10, 1, 1 ), new THREE.ShadowMaterial( { opacity: 0.25 } ) );
        GROUND_MESH.geometry.rotateX( -90 * Math.PI / 180 );
        GROUND_MESH.receiveShadow = true;
        scene.add( GROUND_MESH );
        scene.add( new THREE.GridHelper( 8, 20, 0x000000, 0x999999 ) );
        scene.add( new THREE.AxesHelper( 4 ) );
      }
    //-----------------------------------------------------------------------------------------------
    // (2) MMD 3Dモデルをロードし、シーンに追加
    //-----------------------------------------------------------------------------------------------
      function loadMMD () {
        const LOADER_1 = new THREE.MMDLoader();
        const LOADER_2 = new THREE.MMDLoader();
        LOADER_1.load (
          // オブジェクトで管理しているMMD 3Dモデルのファイル(PMXファイル)のファイル名プロパティーを使用
          PMX_FILE.file,
          function ( mmd ) {
            mesh = mmd;
            // オブジェクトで管理しているMMD 3Dモデルのファイル(PMXファイル)の放出度および輪郭線の太さのプロパティーを使用
            for ( let i = 0; i < mesh.material.length; i ++ ) {
              mesh.material[ i ].emissive.multiplyScalar( PMX_FILE.emissive );
              mesh.material[ i ].userData.outlineParameters.thickness = PMX_FILE.thickness;
            }
            // オブジェクトで管理しているMMD 3Dモデルのファイル(PMXファイル)のセルフシャドウ(receiveShadow)のプロパティーを使用
            mesh.castShadow = true;
            if ( PMX_FILE.receiveShadow ) {
              mesh.receiveShadow = true;
            } else {
              mesh.receiveShadow = false;
            }
            // オブジェクトで管理しているMMD 3Dモデルのファイル(PMXファイル)の倍率のプロパティーを使用
            mesh.scale.copy( new THREE.Vector3( 1, 1, 1 ).multiplyScalar( PMX_FILE.multiply ) );
            const BOUNDING_BOX = new THREE.Box3().setFromObject( mesh );
            vector3.setY( 0.5 * BOUNDING_BOX.max.y );
            light.target.position.copy( new THREE.Vector3( 0, 0.5 * BOUNDING_BOX.max.y, 0 ) );


            // モーションファイル(VMDファイル)を読み込んで、AnimationClip(配列で管理する)を作成
            LOADER_2.loadAnimation( VMD_FILE.file, mesh, function ( motion ) {
            // モーションファイルはAnimationClipとして読み込まれる、配列に保存
            motions = motion;
            // AnimationClipのnameプロパティーの設定
            motions.name = VMD_FILE.name;
            } );


            // オブジェクトで管理しているMMD 3Dモデルのファイル(PMXファイル)の物理演算のプロパティーを使用 物理演算あり(true) / 物理演算なし(false) 
            if ( PMX_FILE.physics ) {
              // (Constructor) MMDAnimationHelper( params : Object )
              // (Method) .add ( object : Object3D, params : Object ) : MMDAnimationHelper
              ANIMATION_HELPER.add( mesh, { animation: motions, physics: true } );
            } else {
              ANIMATION_HELPER.add( mesh, { animation: motions, physics: false } );
            }

            controls.target = new THREE.Vector3( 0, 0.5 * BOUNDING_BOX.max.y, 0 );

            // 再生、停止、一時停止を制御するための AnimationMixer を取得
            // (Property) .objects : WeakMap
            animationMixer = ANIMATION_HELPER.objects.get( mesh ).mixer;
            // AnimationHelperにより開始したモーションを停止する
            // (Method) .stopAllAction () : AnimationMixer
            animationMixer.stopAllAction();
            scene.add( mesh );
          }
        );
      }
    //-----------------------------------------------------------------------------------------------
    // (3)レンダリング (レンダリングループ)
    //-----------------------------------------------------------------------------------------------
      function sceneRender() {
        window.requestAnimationFrame( sceneRender );
        // ポーズの場合、MMDAnimationHelperのupdateは行わない。
        // モーションの場合は、時間を進めて、オブジェクトのアニメーションを更新する
        if ( motionIndex !== -1 ) {
          // (Method) .update ( delta : Number ) : MMDAnimationHelper
          ANIMATION_HELPER.update( CLOCK.getDelta() );
        }
        
          effect.render( scene, camera );
        
      }
  //***********************************************************************************************
  // イベント
  //***********************************************************************************************
    //-----------------------------------------------------------------------------------------------
    // ブラウザー（ウィンドウ）のサイズ変更時の処理
    //-----------------------------------------------------------------------------------------------
      window.addEventListener( 'resize', function () {
        // setScissorとsetViewportで使用する変数（canvasSizeW、canvasSizeH）の値を更新
        canvasSizeW = parseInt( window.getComputedStyle( document.getElementById( 'webgl' ) ).width );
        canvasSizeH = parseInt( window.getComputedStyle( document.getElementById( 'webgl' ) ).height);
        effect.setSize( canvasSizeW, canvasSizeH );
        const width = window.innerWidth;
        const height = window.innerHeight;

        // レンダラーのサイズを調整する
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(width, height);

        // カメラのアスペクト比を正す
        camera.aspect = width / height;
        camera.updateProjectionMatrix();
      }, false );
    //-----------------------------------------------------------------------------------------------
    // モーションの開始/一時停止ボタン
    //-----------------------------------------------------------------------------------------------
        
    document.getElementById('start').addEventListener( 'click', function () {
        // モーションの開始
        if ( motionIndex === -1 ) {
            // モーションを停止する
            //animationMixer.stopAllAction();
            // (Method) .play () : AnimationAction
            animationMixer.clipAction( motions ).play();
            music.play();
            // (Method) .setLoop ( loopMode : Number, repetitions : Number ) : AnimationAction
            animationMixer.clipAction( motions ).setLoop( THREE.LoopOnce );
            motionIndex = 1;
        } else if ( motionIndex === 1 && animationMixer.clipAction( motions ).paused === false ) {
            // モーションの一時停止
            // (Property) .paused : Boolean
            animationMixer.clipAction( motions ).paused = true;
            music.pause();
        } else if ( motionIndex === 1 && animationMixer.clipAction( motions ).paused === true ) {
            // モーションの一時停止から再開
            animationMixer.clipAction( motions ).paused = false;
            music.play();
        }
    }, false );
    </script>
  </body>
</html>